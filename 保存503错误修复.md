# ä¿å­˜ 503 é”™è¯¯ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯ï¼š**
```
ä¿å­˜å‡ºé”™: Server returned non-JSON response: 503
```

**ç—‡çŠ¶ï¼š**
- âœ… æ–‡ä»¶å¯ä»¥æ‰“å¼€
- âœ… æ–‡ä»¶å¯ä»¥ç¼–è¾‘
- âŒ ä¿å­˜æ—¶æŠ¥ 503 é”™è¯¯

## ğŸ” é—®é¢˜åˆ†æ

### 503 é”™è¯¯çš„å¯èƒ½åŸå› 

1. **æƒé™æ£€æŸ¥é€»è¾‘é”™è¯¯**ï¼ˆå·²ä¿®å¤ï¼‰
   - `file_content` å‡½æ•°çš„æƒé™é€»è¾‘æœ‰ bug
   - ä¸ `editor` å‡½æ•°ç›¸åŒçš„é—®é¢˜

2. **æœåŠ¡å™¨è¶…æ—¶æˆ–å´©æºƒ**
   - Flask åº”ç”¨å¯èƒ½å´©æºƒäº†
   - éœ€è¦æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—

3. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   - è¿œç¨‹æ•°æ®åº“è¿æ¥è¶…æ—¶
   - MySQL è¿æ¥æ± è€—å°½

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### ä¿®å¤ `file_content` å‡½æ•°æƒé™é€»è¾‘

**ä½ç½®ï¼š** `documents.py` ç¬¬ 254-260 è¡Œ

**ä¿®å¤å‰ï¼š**
```python
if not is_owner:
    share = DocumentShare.query.filter_by(...).first()
    if share:
        can_view = True  # âŒ åªè®¾ç½®äº† can_view
        if share.permission == 'edit':
            can_edit = True  # âŒ ä½† can_view ä»ç„¶æ˜¯ False
```

**ä¿®å¤åï¼š**
```python
if not is_owner:
    share = DocumentShare.query.filter_by(...).first()
    if share:
        can_view = True  # âœ… æœ‰åˆ†äº«è®°å½•å°±èƒ½æŸ¥çœ‹
        if share.permission == 'edit':
            can_edit = True  # âœ… edit æƒé™å¯ä»¥ç¼–è¾‘
```

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### 1. é‡å¯ Flask åº”ç”¨

**å¿…é¡»é‡å¯æ‰èƒ½åº”ç”¨ä»£ç ä¿®æ”¹ï¼š**
```powershell
# åœ¨è¿è¡Œ python app.py çš„çª—å£æŒ‰ Ctrl+C
# é‡æ–°å¯åŠ¨
python app.py
```

### 2. æŸ¥çœ‹ Flask æ—¥å¿—

ä¿å­˜æ—¶æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼Œçœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼š
```
127.0.0.1 - - [04/Dec/2025 01:15:00] "POST /documents/content/20 HTTP/1.1" 503
```

å¦‚æœæœ‰ Python é”™è¯¯å †æ ˆï¼Œè®°å½•ä¸‹æ¥ã€‚

### 3. æµ‹è¯•ä¿å­˜åŠŸèƒ½

```
1. æ‰“å¼€å…±äº«æ–‡æ¡£
2. ç¼–è¾‘å†…å®¹
3. ç‚¹å‡»"ä¿å­˜"
4. æŸ¥çœ‹ï¼š
   - æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - Flask ç»ˆç«¯æ—¥å¿—
   - ç½‘ç»œè¯·æ±‚è¯¦æƒ…
```

### 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥

```powershell
# æµ‹è¯•æ•°æ®åº“è¿æ¥
python -c "from app import create_app; from extensions import db; app = create_app(); app.app_context().push(); db.session.execute('SELECT 1')"
```

## ğŸš¨ 503 é”™è¯¯çš„å…¶ä»–å¯èƒ½åŸå› 

### åŸå› 1ï¼šFlask åº”ç”¨å´©æºƒ

**ç—‡çŠ¶ï¼š**
- ä¿å­˜æ—¶åº”ç”¨å´©æºƒ
- ç»ˆç«¯æ˜¾ç¤ºé”™è¯¯å †æ ˆ
- éœ€è¦é‡å¯åº”ç”¨

**è§£å†³ï¼š**
æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œä¿®å¤å¯¼è‡´å´©æºƒçš„ä»£ç 

### åŸå› 2ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶

**ç—‡çŠ¶ï¼š**
- ä¿å­˜æ—¶è¿æ¥è¿œç¨‹æ•°æ®åº“è¶…æ—¶
- æ—¥å¿—æ˜¾ç¤ºï¼š`OperationalError: (2003, "Can't connect to MySQL server")`

**è§£å†³ï¼š**
```python
# åœ¨ config.py æ·»åŠ è¿æ¥æ± é…ç½®
SQLALCHEMY_POOL_SIZE = 10
SQLALCHEMY_POOL_TIMEOUT = 30
SQLALCHEMY_POOL_RECYCLE = 3600
```

### åŸå› 3ï¼šæ–‡ä»¶å†™å…¥æƒé™é—®é¢˜

**ç—‡çŠ¶ï¼š**
- æ— æ³•å†™å…¥ uploads æ–‡ä»¶å¤¹
- æ—¥å¿—æ˜¾ç¤ºï¼š`PermissionError`

**è§£å†³ï¼š**
```powershell
# æ£€æŸ¥ uploads æ–‡ä»¶å¤¹æƒé™
icacls uploads
```

### åŸå› 4ï¼šå†…å®¹è¿‡å¤§

**ç—‡çŠ¶ï¼š**
- ä¿å­˜å¤§æ–‡ä»¶æ—¶è¶…æ—¶
- è¶…è¿‡ 16MB é™åˆ¶

**è§£å†³ï¼š**
```python
# åœ¨ config.py å¢åŠ é™åˆ¶
MAX_CONTENT_LENGTH = 32 * 1024 * 1024  # 32MB
```

## ğŸ§ª è°ƒè¯•æ–¹æ³•

### æ–¹æ³•1ï¼šæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ï¼š
1. **Console** - JavaScript é”™è¯¯
2. **Network** - è¯·æ±‚è¯¦æƒ…
   - çŠ¶æ€ç 
   - å“åº”å†…å®¹
   - è¯·æ±‚å¤´

### æ–¹æ³•2ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `file_content` å‡½æ•°æ·»åŠ æ—¥å¿—ï¼š
```python
elif request.method == 'POST':
    print(f"[DEBUG] Saving document {doc_id}")
    print(f"[DEBUG] can_edit: {can_edit}")
    
    if not can_edit:
        print(f"[DEBUG] Unauthorized to edit")
        return jsonify({'error': 'Unauthorized to edit'}), 403
    
    try:
        data = request.get_json()
        print(f"[DEBUG] Received data: {len(data.get('content', ''))} chars")
        # ... ä¿å­˜é€»è¾‘
        print(f"[DEBUG] Save successful")
        return jsonify({'message': 'Saved successfully'})
    except Exception as e:
        print(f"[DEBUG] Save error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500
```

### æ–¹æ³•3ï¼šä½¿ç”¨ curl æµ‹è¯•

```powershell
# æµ‹è¯•ä¿å­˜æ¥å£
curl -X POST http://localhost:5000/documents/content/20 `
  -H "Content-Type: application/json" `
  -d '{"content":"test"}'
```

## ğŸ“ å®Œæ•´çš„ä¿å­˜æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"
    â†“
JavaScript å‘é€ POST è¯·æ±‚
    â†“
Flask æ¥æ”¶è¯·æ±‚ /documents/content/{doc_id}
    â†“
æ£€æŸ¥ JWT è®¤è¯
    â†“
æ£€æŸ¥æƒé™ï¼ˆcan_view, can_editï¼‰
    â†“
è·å– JSON æ•°æ®
    â†“
å†™å…¥æ–‡ä»¶
    â†“
æ›´æ–°æ•°æ®åº“ï¼ˆæ–‡ä»¶å¤§å°ï¼‰
    â†“
è¿”å› JSON å“åº”
    â†“
å‰ç«¯æ˜¾ç¤º"å·²ä¿å­˜"
```

## âœ¨ ä¿®å¤åçš„é¢„æœŸè¡Œä¸º

1. âœ… æ‰“å¼€å…±äº«æ–‡æ¡£ï¼ˆedit æƒé™ï¼‰
2. âœ… ç¼–è¾‘å†…å®¹
3. âœ… ç‚¹å‡»"ä¿å­˜"
4. âœ… æ˜¾ç¤º"Saving..."
5. âœ… æ˜¾ç¤º"å·²ä¿å­˜"ï¼ˆç»¿è‰²ï¼‰
6. âœ… åˆ·æ–°é¡µé¢ï¼Œå†…å®¹å·²æ›´æ–°

## ğŸš€ ç«‹å³æ“ä½œ

1. **é‡å¯ Flask åº”ç”¨**ï¼ˆå¿…é¡»ï¼‰
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼ˆCtrl+Shift+Deleteï¼‰
3. **åˆ·æ–°é¡µé¢**ï¼ˆCtrl+F5ï¼‰
4. **é‡æ–°æµ‹è¯•ä¿å­˜**

---

**å¦‚æœé‡å¯åä»ç„¶ 503ï¼Œè¯·æä¾›ï¼š**
1. Flask ç»ˆç«¯çš„å®Œæ•´é”™è¯¯æ—¥å¿—
2. æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
3. Network æ ‡ç­¾ä¸­çš„è¯·æ±‚è¯¦æƒ…
