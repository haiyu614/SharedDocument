# 远程存储配置说明

## 概述
系统已配置为将文件存储到云服务器（8.138.190.109）而不是本地存储。

## 配置信息

### 远程服务器配置
- **服务器地址**: 8.138.190.109
- **SSH端口**: 22
- **用户名**: admin
- **密码**: 123456
- **远程存储目录**: /home/admin/uploads

### 配置文件位置
所有配置都在 `config.py` 文件中：

```python
# 远程存储配置（云服务器SFTP）
USE_REMOTE_STORAGE = True  # 启用远程存储
REMOTE_HOST = '8.138.190.109'
REMOTE_PORT = 22
REMOTE_USERNAME = 'admin'
REMOTE_PASSWORD = '123456'
REMOTE_UPLOAD_DIR = '/home/admin/uploads'  # 远程服务器上的上传目录
```

## 部署步骤

### 1. 安装依赖
首先需要安装新的依赖包：

```bash
pip install -r requirements.txt
```

这会安装 `paramiko` 库，用于SFTP连接。

### 2. 配置远程服务器

在云服务器上创建上传目录：

```bash
ssh admin@8.138.190.109
mkdir -p /home/admin/uploads
chmod 755 /home/admin/uploads
```

### 3. 测试连接

可以使用以下Python脚本测试SFTP连接：

```python
from remote_storage import get_remote_storage

try:
    storage = get_remote_storage()
    sftp = storage.connect()
    print("SFTP连接成功！")
    storage.close()
except Exception as e:
    print(f"连接失败: {e}")
```

### 4. 启动应用

```bash
python app.py
```

## 功能说明

### 支持的操作

1. **文件上传**: 文件会自动上传到远程服务器的 `/home/admin/uploads` 目录
2. **文件下载**: 从远程服务器下载文件到内存，然后发送给用户
3. **文件删除**: 删除远程服务器上的文件
4. **文件编辑**: 支持在线编辑，保存时会更新远程文件
5. **文件查看**: 从远程服务器读取文件内容

### 自动处理的文件类型

- 文本文件（txt, md, py等）
- Office文档（doc, docx, xls, xlsx等）
- 图片文件（jpg, png, gif等）
- 压缩文件（zip, rar等）

## 切换存储模式

### 切换到本地存储

如果需要切换回本地存储，只需在 `config.py` 中修改：

```python
USE_REMOTE_STORAGE = False  # 禁用远程存储
```

### 切换到远程存储

```python
USE_REMOTE_STORAGE = True  # 启用远程存储
```

## 注意事项

1. **网络连接**: 确保应用服务器能够访问云服务器的22端口（SSH）
2. **权限设置**: 确保远程用户有读写 `/home/admin/uploads` 目录的权限
3. **防火墙**: 确保云服务器防火墙允许SSH连接
4. **性能考虑**: 远程存储会增加网络延迟，大文件操作可能较慢
5. **安全性**: 建议使用SSH密钥认证替代密码认证（生产环境）

## 故障排查

### 连接失败

如果出现连接失败：

1. 检查服务器地址和端口是否正确
2. 检查用户名和密码是否正确
3. 检查网络连接是否正常
4. 检查防火墙设置

### 文件上传失败

1. 检查远程目录是否存在
2. 检查用户权限
3. 检查磁盘空间

### 查看日志

应用会在控制台输出错误信息，注意查看：

```
远程上传错误: [错误信息]
文件下载失败: [错误信息]
Error deleting remote file: [错误信息]
```

## 生产环境建议

1. **使用SSH密钥**: 替代密码认证
2. **配置环境变量**: 不要在代码中硬编码密码
3. **启用HTTPS**: 保护数据传输
4. **定期备份**: 定期备份远程存储的文件
5. **监控磁盘空间**: 监控远程服务器磁盘使用情况
6. **日志记录**: 记录所有文件操作日志

## 环境变量配置示例

```python
# config.py
import os

class Config:
    # ...其他配置...
    
    # 远程存储配置
    USE_REMOTE_STORAGE = os.environ.get('USE_REMOTE_STORAGE', 'True') == 'True'
    REMOTE_HOST = os.environ.get('REMOTE_HOST', '8.138.190.109')
    REMOTE_PORT = int(os.environ.get('REMOTE_PORT', 22))
    REMOTE_USERNAME = os.environ.get('REMOTE_USERNAME', 'admin')
    REMOTE_PASSWORD = os.environ.get('REMOTE_PASSWORD', '123456')
    REMOTE_UPLOAD_DIR = os.environ.get('REMOTE_UPLOAD_DIR', '/home/admin/uploads')
```

然后在启动前设置环境变量：

```bash
export REMOTE_PASSWORD='your_secure_password'
python app.py
```
