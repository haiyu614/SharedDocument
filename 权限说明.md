# 文档分享权限说明

## ✅ 已修复权限控制问题

之前的代码虽然支持两种权限，但编辑器没有正确实现只读模式。现在已经修复！

---

## 📋 两种分享权限

### 1. **仅查看（view）**
- ✅ 可以打开文档查看内容
- ✅ 可以下载文档
- ✅ 可以看到实时更新（其他人编辑时）
- ❌ **不能编辑**
- ❌ **不能保存**
- 界面显示：**"只读模式"** 标识
- 编辑器：灰色显示，无法输入

### 2. **可编辑（edit）**
- ✅ 可以查看内容
- ✅ 可以下载文档
- ✅ 可以在线编辑
- ✅ 可以保存修改
- ✅ 可以实时协作编辑
- 界面显示：**"保存"** 按钮
- 编辑器：正常编辑

---

## 🎯 如何分享文档

### 第一步：上传文档
1. 登录系统
2. 上传文档（支持 txt, md, doc, docx, xls, xlsx 等）

### 第二步：分享文档
1. 在"我的文档"中找到要分享的文件
2. 点击文件卡片上的 **分享图标** 🔗
3. 输入对方的**用户名**
4. 选择权限：
   - **仅查看** - 对方只能看，不能改
   - **可编辑** - 对方可以修改和保存
5. 点击"分享"

### 第三步：对方查看
1. 对方登录系统
2. 点击左侧菜单 **"与我共享"**
3. 看到被分享的文件
4. 点击文件进入查看/编辑

---

## 🔍 权限验证

### 前端验证
- ✅ 只读用户：编辑器设置为 `readOnly`
- ✅ 只读用户：隐藏"保存"按钮，显示"只读模式"
- ✅ 只读用户：无法通过 WebSocket 广播更新
- ✅ 只读用户：点击保存会提示"您没有编辑权限"

### 后端验证
- ✅ 保存文档时检查权限（`documents.py` 第 209-221 行）
- ✅ 只有 `edit` 权限才能保存
- ✅ 无权限返回 403 错误

---

## 📱 使用示例

### 场景1：团队协作文档
```
你（所有者）：创建文档，分享给同事（可编辑）
同事A：可以编辑和保存
同事B：可以编辑和保存
实时协作：所有人同时编辑，实时同步
```

### 场景2：只读分享
```
你（所有者）：创建文档，分享给客户（仅查看）
客户：可以查看内容，可以下载
客户：无法修改，编辑器显示"只读模式"
```

### 场景3：混合权限
```
你（所有者）：创建文档
分享给同事A：可编辑
分享给同事B：仅查看
分享给客户：仅查看

同事A：可以编辑
同事B和客户：只能查看
```

---

## 🔧 技术实现

### 修改的文件
1. **`templates/editor.html`**
   - 添加 `can_edit` 变量传递
   - 根据权限显示/隐藏保存按钮
   - 设置 `readOnly` 属性
   - 禁止只读用户广播更新

### 权限检查流程
```
用户打开文档
    ↓
检查是否为所有者
    ↓
如果不是，查询 document_shares 表
    ↓
检查 permission 字段
    ↓
permission = 'edit' → can_edit = True
permission = 'view' → can_edit = False
    ↓
传递给模板渲染
    ↓
前端根据 can_edit 控制界面
```

---

## ✨ 新增功能

### 只读模式视觉效果
- 编辑器背景变暗（opacity: 0.7）
- 光标变为禁止图标（cursor: not-allowed）
- 顶部显示"只读模式"标识
- 隐藏"保存"按钮

### 实时同步优化
- 只读用户可以看到其他人的编辑
- 只读用户的输入不会广播（防止误操作）
- 编辑用户的更新会实时同步给所有人

---

## 🧪 测试步骤

### 测试只读权限
1. 用户A登录，上传文档
2. 用户A分享给用户B，权限选择"仅查看"
3. 用户B登录，打开共享文档
4. 验证：
   - ✅ 可以看到内容
   - ✅ 编辑器显示"只读模式"
   - ✅ 无法输入文字
   - ✅ 没有"保存"按钮
   - ✅ 可以下载文档

### 测试编辑权限
1. 用户A登录，上传文档
2. 用户A分享给用户C，权限选择"可编辑"
3. 用户C登录，打开共享文档
4. 验证：
   - ✅ 可以编辑内容
   - ✅ 可以保存
   - ✅ 有"保存"按钮
   - ✅ 编辑会实时同步给用户A

### 测试实时协作
1. 用户A和用户C同时打开同一文档
2. 用户A输入内容
3. 验证：用户C实时看到更新
4. 用户C输入内容
5. 验证：用户A实时看到更新

---

## 🎉 总结

现在的权限系统已经完善：
- ✅ 支持两种权限：仅查看、可编辑
- ✅ 前端和后端双重验证
- ✅ 只读模式有明确的视觉提示
- ✅ 实时协作功能正常工作
- ✅ 安全性得到保障

**分享文档时，记得根据需求选择正确的权限！**
