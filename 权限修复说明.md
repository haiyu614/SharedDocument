# 共享文档权限显示修复

## 🐛 问题描述

**之前的问题：**
- 别人分享给我"可编辑"权限的文档
- 我收到后只能看到"眼睛"图标（查看）
- 无法看到"编辑"图标
- 实际上点击进去是可以编辑的，但界面提示不明确

## ✅ 修复内容

### 1. 修改 `auth.py`（第 208-221 行）
**添加权限映射传递：**
```python
# 创建文档ID到权限的映射
doc_permissions = {}
for share in shared_shares:
    if share.document:
        shared_documents.append(share.document)
        doc_permissions[share.document.id] = share.permission  # 记录权限
```

**传递给模板：**
```python
return render_template('index.html', ..., doc_permissions=doc_permissions)
```

### 2. 修改 `doc_card.html`（第 37-59 行）
**根据权限显示不同图标：**
- `edit` 权限 → 显示 ✏️ 编辑图标（蓝色）
- `view` 权限 → 显示 👁️ 查看图标（灰色）

## 🎯 修复后的效果

### 场景1：收到"可编辑"权限的文档
```
文档卡片显示：
┌─────────────────────┐
│  📄 文档名称         │
│  来自 张三          │
│                 ✏️  │  ← 编辑图标（蓝色）
└─────────────────────┘

鼠标悬停提示："编辑"
点击后：可以正常编辑和保存
```

### 场景2：收到"仅查看"权限的文档
```
文档卡片显示：
┌─────────────────────┐
│  📄 文档名称         │
│  来自 李四          │
│                 👁️  │  ← 查看图标（灰色）
└─────────────────────┘

鼠标悬停提示："仅查看"
点击后：只读模式，无法编辑
```

### 场景3：自己的文档
```
文档卡片显示：
┌─────────────────────┐
│  📄 我的文档         │
│  2025-12-04         │
│          ✏️ 🔗 ❌   │  ← 编辑、分享、删除
└─────────────────────┘
```

## 🔍 权限判断逻辑

```
显示文档卡片
    ↓
是否为所有者？
    ├─ 是 → 显示：编辑 + 分享 + 删除
    └─ 否 → 检查 doc_permissions
            ├─ edit → 显示：编辑图标（蓝色）
            └─ view → 显示：查看图标（灰色）
```

## 🧪 测试步骤

### 测试1：可编辑权限
1. 用户A登录，上传文档
2. 用户A分享给用户B，权限选择"可编辑"
3. 用户B登录，进入"与我共享"
4. 验证：
   - ✅ 文档卡片显示 ✏️ 编辑图标（蓝色）
   - ✅ 鼠标悬停显示"编辑"
   - ✅ 点击后可以编辑和保存

### 测试2：仅查看权限
1. 用户A登录，上传文档
2. 用户A分享给用户C，权限选择"仅查看"
3. 用户C登录，进入"与我共享"
4. 验证：
   - ✅ 文档卡片显示 👁️ 查看图标（灰色）
   - ✅ 鼠标悬停显示"仅查看"
   - ✅ 点击后显示"只读模式"，无法编辑

### 测试3：混合权限
1. 用户A上传两个文档
2. 文档1分享给用户B：可编辑
3. 文档2分享给用户B：仅查看
4. 用户B登录，验证：
   - ✅ 文档1显示编辑图标
   - ✅ 文档2显示查看图标
   - ✅ 图标颜色不同（蓝色 vs 灰色）

## 📊 图标对照表

| 权限类型 | 图标 | 颜色 | 提示文字 | 功能 |
|---------|------|------|---------|------|
| 所有者 | ✏️ | 蓝色 | 编辑 | 完全控制 |
| 可编辑 | ✏️ | 蓝色 | 编辑 | 可编辑+保存 |
| 仅查看 | 👁️ | 灰色 | 仅查看 | 只读模式 |

## 🎨 视觉区分

### 可编辑文档
- 图标：`<i class="fas fa-edit"></i>`
- 颜色：`var(--primary)` （蓝色）
- 提示：`title="编辑"`

### 仅查看文档
- 图标：`<i class="fas fa-eye"></i>`
- 颜色：`var(--text-muted)` （灰色）
- 提示：`title="仅查看"`

## 🔄 完整流程

```
1. 用户A分享文档
   ↓
2. 选择权限（edit/view）
   ↓
3. 保存到 document_shares 表
   ↓
4. 用户B登录查看
   ↓
5. 后端查询权限
   ↓
6. 传递 doc_permissions 到模板
   ↓
7. 模板根据权限显示图标
   ↓
8. 用户B看到正确的图标和提示
```

## ✨ 改进点

### 之前
- ❌ 所有共享文档都显示眼睛图标
- ❌ 无法区分可编辑和只读
- ❌ 用户体验混乱

### 现在
- ✅ 根据权限显示不同图标
- ✅ 颜色区分（蓝色/灰色）
- ✅ 提示文字清晰
- ✅ 用户一眼就能看出权限

## 🚀 下次使用

**重启应用后生效：**
```powershell
# 停止旧的应用
Ctrl + C

# 重新启动
python app.py
```

现在共享文档的权限显示就正确了！
